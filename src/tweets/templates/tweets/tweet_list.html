{% extends 'base.html' %}

{% block scripts %}
    <script>

        function getParameterByName(name, url) {
            if (!url) {
              url = window.location.href;
            }
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        $(document).ready(function () {
            var query = getParameterByName('q');
            var tweetList = [];
            function parseTweets() {
                if (tweetList == 0){
                    $("#tweet-container").text("No encontramos ningún tweet")
                }else {
                    // tweets exists, parse them
                    $.each(tweetList, function (key, value) {
                        var tweetKey = key;
                        var tweetContent = value.content;
                        var tweetUser = value.user;
                        var dateDisplay = value.date_display;
                        var timeSince = value.timesince;
                        $("#tweet-container").append(
                            "<div class=\"media\"> <div class=\"media-body\">" + tweetContent + "<br/> via: " + tweetUser.username + " | " + dateDisplay + " | " + "<a href='#'>View</a>" + "</div></div><hr/>"
                        );
                    })
                }
            }

            function fecthTweets() {
                console.log("fetching....")
                $.ajax({
                    // forma de usarlo desde un .js separado
                    url:"/api/tweet/?q=somequery",
                    //esto funcionaría si se pone directo en el template, si se pusiera en un archivo .js separado
                    // YA NO FUNCINARIA, se usaría como se muestra en la asignación a url de arriba.
                    //url: "{% url 'tweet-api:list' %}",
                    data:{
                        "q": query,
                    },
                    method:"GET",
                    success: function (data) {
                        tweetList = data;
                        parseTweets();

                    },
                    error: function (data) {
                        console.log("error");
                        console.log(data)
                    }

                })
            }

            fecthTweets()

            $("#tweet-form").submit(function (event) {
                event.preventDefault();
                var this_ = $(this);
                var formData = this_.serialize();

                $.ajax({
                    // forma de usarlo desde un .js separado
                    url:"/api/tweet/create/",
                    //esto funcionaría si se pone directo en el template, si se pusiera en un archivo .js separado
                    // YA NO FUNCINARIA, se usaría como se muestra en la asignación a url de arriba.
                    //url: "{% url 'tweet-api:list' %}",
                    data: formData,
                    method:"POST",
                    success: function (data) {
                        //console.log(data);
                        fecthTweets();

                    },
                    error: function (data) {
                        console.log("error");
                        console.log(data)
                        console.log(data.status)
                    }

                })
            })


        });
    </script>
{%  endblock scripts %}
{% block content %}
    <div class="row">
        <div class="col-sm-3 col-xs-12" style="background-color: red;">
            <h1>
                {{ request.user }}
            </h1>
        </div>
        <div class="col-sm-9">
            {% if not request.GET.q %}
                <div class="">
                    {% include "tweets/form.html" with form=create_form action_url=create_url btn_title="Tweet" form_id="tweet-form" %}
                </div>
                <hr />
            {% endif %}

            <div id="tweet-container">

            </div>
        </div>
    </div>
{% endblock content %}
