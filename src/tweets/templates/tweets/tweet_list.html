{% extends 'base.html' %}

{% block scripts %}
    <script>

        function getParameterByName(name, url) {
            if (!url) {
              url = window.location.href;
            }
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        $(document).ready(function () {
            var query = getParameterByName('q');
            var tweetList = [];
            var nextTweetUrl;

            $(document.body).on("click", ".retweet", function (e) {
                e.preventDefault();
                console.log("clicked..")
                var url = "/api" + $(this).attr("href");
                $.ajax({
                    method: "GET",
                    url: url ,
                    success: function (data) {
                        attachTweet(data, true,true);
                        updateHashLinks()
                    },
                    error: function (data) {
                        console.log("error, no pudimos retweetear haz un log del data...");

                    }
                })
            })

            function updateHashLinks() {
                $(".media-body").each(function (data) {
                    var hashtagRegex = /(^|\s)#([\w\d-]+)/g
                    var usernameRegex = /(^|\s)@([\w\d-]+)/g
                    var currentHtml = $(this).html();
                    var newText;
                    var newText = currentHtml.replace(hashtagRegex, "$1<a href='/tags/$2/'>#$2</a>")
                    var newText = newText.replace(usernameRegex, "$1<a href='/$2/'>@$2</a>")
                    $(this).html(newText)
                })
            }

            function attachTweet(tweetValue, preppend, retweet){
                var tweetContent = tweetValue.content;
                var tweetUser = tweetValue.user;
                var dateDisplay = tweetValue.date_display;
                var tweetFormattedHtml;
                if(retweet && tweetValue.parent){
                    // retweet
                    var mainTweet = tweetValue.parent;
                    tweetFormattedHtml = "<div class=\"media\"><div class=\"media-body\"> <span class='gray-color'>Retweet via <a href='" + mainTweet.user.url + "'> " + mainTweet.user.username + " </a> on " + dateDisplay + "</span><br/>" + mainTweet.content + "<br/> via: <a href='" + tweetUser.url + "'>" + tweetUser.username  + "</a> | " + mainTweet.date_display + " | " + "<a href='/tweet/" + mainTweet.id  + "'" + ">View</a>" + " | " + "<a class='retweet' href='/tweet/" + tweetValue.id  + "/retweet'" + ">Retweet</a>" + "</div></div><hr/>"
                }else{
                    // new tweet
                    tweetFormattedHtml = "<div class=\"media\"><div class=\"media-body\">" + tweetContent + "<br/> via: <a href='" + tweetUser.url + "'>" + tweetUser.username + "</a> | " + dateDisplay + " | " + "<a href='/tweet/" + tweetValue.id  + "'" + ">View</a>" + " | " + "<a class='retweet' href='/tweet/" + tweetValue.id  + "/retweet'" + ">Retweet</a>" + "</div></div><hr/>"
                }


                if (preppend == true){
                    $("#tweet-container").prepend(
                        tweetFormattedHtml
                    );
                }else{
                    $("#tweet-container").append(
                        tweetFormattedHtml
                    );
                }
            }
            function parseTweets() {
                if (tweetList == 0){
                    $("#tweet-container").text("No encontramos ningún tweet")
                }else {
                    // tweets exists, parse them
                    $.each(tweetList, function (key, value) {
                        var tweetKey = key;
                        if (value.parent){
                            attachTweet(value, false, true);
                        }else{
                            attachTweet(value);
                        }

                    })
                }
            }

            function fecthTweets(url) {
                console.log("fetching....")
                var fetchUrl;
                if (!url){
                    fetchUrl = "/api/tweet/"
                }else{
                    fetchUrl = url;
                }

                $.ajax({
                    // forma de usarlo desde un .js separado
                    //url:"/api/tweet/",
                    url: fetchUrl,
                    //esto funcionaría si se pone directo en el template, si se pusiera en un archivo .js separado
                    // YA NO FUNCINARIA, se usaría como se muestra en la asignación a url de arriba.
                    //url: "{% url 'tweet-api:list' %}",
                    data:{
                        "q": query,
                    },
                    method:"GET",
                    success: function (data) {

                        //with pagination
                        tweetList = data.results;
                        if (data.next){
                            nextTweetUrl = data.next;
                        }else{
                            $("#loadmore").css("display","none");
                        }
                        // whitout pagination
                        //tweetList = data;
                        parseTweets();
                        updateHashLinks()

                    },
                    error: function (data) {
                        console.log("error");
                        console.log(data)
                    }

                })
            }

            fecthTweets()

            $("#loadmore").click(function (event) {
                event.preventDefault();
                //load more items
                if (nextTweetUrl){
                    fecthTweets(nextTweetUrl);
                }
            })

            var charsStart = 140;
            var charsCurrent = 0;

            $("#tweet-form").append("<span id='tweetCharsLeft'>" + charsStart + "</span>");

            $("#tweet-form textarea").keyup(function (event) {
                var tweetValue = $(this).val()
                charsCurrent = charsStart - tweetValue.length;
                var spanChars = $("#tweetCharsLeft")
                $("#tweetCharsLeft").text(charsCurrent);

                if (charsCurrent > 0){
                    //remove clases
                    spanChars.removeClass("gray-color");
                    spanChars.removeClass("red-color");
                }else if (charsCurrent == 0){
                    //add gray class
                    spanChars.removeClass("red-color");
                    spanChars.addClass("gray-color");
                }else if (charsCurrent < 0){
                    // add red class
                    spanChars.removeClass("gray-color");
                    spanChars.addClass("red-color");
                }


            })

            $("#tweet-form").submit(function (event) {
                event.preventDefault();
                var this_ = $(this);
                var formData = this_.serialize();
                if (charsCurrent >= 0){
                    $.ajax({
                        // forma de usarlo desde un .js separado
                        url:"/api/tweet/create/",
                        //esto funcionaría si se pone directo en el template, si se pusiera en un archivo .js separado
                        // YA NO FUNCINARIA, se usaría como se muestra en la asignación a url de arriba.
                        //url: "{% url 'tweet-api:list' %}",
                        data: formData,
                        method:"POST",
                        success: function (data) {
                            this_.find("input[type=text], textarea").val("");
                            attachTweet(data, true)
                            updateHashLinks()

                        },
                        error: function (data) {
                            console.log("error");
                            console.log(data)
                            console.log(data.status)
                        }

                    })
                }else{
                    console.log("no podemos enviar este tweet es demasiado largo")
                }
            })


        });
    </script>
{%  endblock scripts %}
{% block content %}
    <div class="row">
        <div class="col-sm-3 col-xs-12" style="background-color: red;">
            <h1>
                {{ request.user }}
            </h1>
        </div>
        <div class="col-sm-9">
            {% if not request.GET.q %}
                <div class="">
                    {% include "tweets/form.html" with form=create_form action_url=create_url btn_title="Tweet" form_id="tweet-form" %}
                </div>
                <hr />
            {% endif %}

            <div id="tweet-container">

            </div>
            <a href="#" id="loadmore">Cargar más tweets</a>
        </div>
    </div>
{% endblock content %}
